name: Deploy Development Version

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Development Version
        run: |
          ssh ${{ secrets.EC2_HOST }} '
            echo "ğŸš€ Starting development version deployment..."
            
            cd /home/ubuntu/hrms/docker
            
            # Pull latest code
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main
            
            # Stop development container
            echo "ğŸ“¦ Stopping development container..."
            docker compose down hrms-dev || true
            
            # Remove old development image
            echo "ğŸ—‘ï¸ Removing old development image..."
            docker rmi docker-hrms-dev 2>/dev/null || echo "No old image to remove"
            
            # Build new development version
            echo "ğŸ”¨ Building new development version..."
            docker compose build --no-cache hrms-dev
            
            # Start development version
            echo "ğŸš€ Starting development version..."
            docker compose up -d hrms-dev
            
            # Wait for service to be ready
            echo "â³ Waiting for service to be ready..."
            sleep 30
            
            # Check if service is running
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "âœ… Development version deployed successfully!"
              echo "ğŸŒ Access URL: http://${{ secrets.EC2_HOST }}:3000"
            else
              echo "âŒ Development version failed to start"
              echo "ğŸ“‹ Recent logs:"
              docker compose logs --tail=20 hrms-dev
              exit 1
            fi
            
            echo "ğŸ“Š Container Status:"
            docker compose ps hrms-dev
          ' 